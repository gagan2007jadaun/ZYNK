<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>ZYNK ‚Äî Feed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Theme -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            zynk: '#12E6E6',
            dark: '#0A0A0A',
            card: '#121212'
          }
        }
      }
    }
  </script>
  <script src="../utils/theme.js"></script>
  <script src="../utils/social.js"></script>
  <script src="../utils/sidebar.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      renderSidebar('Feed');
    });
  </script>
</head>
<style>
  .image-preview {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    flex-wrap: wrap;
  }

  .image-preview img {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 12px;
    border: 1px solid #333;
  }

  .image-box {
    position: relative;
  }

  .remove-img {
    position: absolute;
    top: 6px;
    right: 6px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border-radius: 50%;
    font-size: 12px;
    width: 20px;
    height: 20px;
    text-align: center;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .hidden {
    display: none;
  }
</style>

<body class="bg-gray-50 text-gray-900 dark:bg-dark dark:text-white min-h-screen flex transition-colors duration-300">

  <!-- LEFT SIDEBAR -->
  <aside class="hidden md:flex flex-col w-64 p-6 border-r border-gray-200 dark:border-gray-800">
    <h1 class="text-2xl font-bold text-zynk mb-8">ZYNK</h1>

    <nav id="sidebar" class="space-y-4 text-gray-600 dark:text-gray-300">
      <!-- Sidebar rendered by JS -->
    </nav>
  </aside>

  <!-- MAIN FEED -->
  <main class="flex-1 max-w-2xl mx-auto border-x border-gray-200 dark:border-gray-800">

    <!-- FEED TABS -->
    <div
      class="sticky top-0 z-10 bg-white/80 dark:bg-dark/80 backdrop-blur-md border-b border-gray-200 dark:border-gray-800 flex">
      <button onclick="switchFeed('foryou')" id="tab-foryou"
        class="flex-1 p-4 hover:bg-gray-100 dark:hover:bg-white/5 transition relative group">
        <span class="font-bold text-gray-900 dark:text-white">For you</span>
        <div class="absolute bottom-0 left-0 w-full h-1 bg-zynk rounded-full"></div>
      </button>
      <button onclick="switchFeed('inOrbit')" id="tab-inOrbit"
        class="flex-1 p-4 hover:bg-gray-100 dark:hover:bg-white/5 transition relative group">
        <span
          class="font-medium text-gray-500 group-hover:text-gray-900 dark:text-gray-500 dark:group-hover:text-gray-300">In
          Orbit</span>
        <div class="absolute bottom-0 left-0 w-full h-1 bg-transparent rounded-full"></div>
      </button>
    </div>

    <!-- CREATE POST -->
    <div class="p-6 border-b border-gray-200 dark:border-gray-800">
      <textarea id="postInput" placeholder="Say something raw..." class="w-full bg-transparent resize-none outline-none text-lg
               placeholder-gray-500 text-gray-800 dark:text-white" rows="3"></textarea>

      <!-- Image Preview Container -->
      <div id="imagePreview" class="image-preview hidden"></div>

      <!-- Input Options Toolbar -->
      <div class="flex items-center gap-4 mt-3 border-t border-gray-100 dark:border-gray-800/50 pt-3">
        <button onclick="openImagePicker()"
          class="text-zynk hover:text-white transition p-1.5 rounded-full hover:bg-zynk/10" title="Media">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
          </svg>
        </button>
        <button class="text-zynk hover:text-white transition p-1.5 rounded-full hover:bg-zynk/10" title="GIF">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 8V4H8" />
            <rect width="16" height="12" x="4" y="8" rx="2" />
            <path d="M2 14h2" />
            <path d="M20 14h2" />
            <path d="M15 13h2" />
            <path d="M15 17h2" />
          </svg>
        </button>
        <button class="text-zynk hover:text-white transition p-1.5 rounded-full hover:bg-zynk/10" title="Poll">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M8 6h13" />
            <path d="M8 12h13" />
            <path d="M8 18h13" />
            <path d="M3 6h.01" />
            <path d="M3 12h.01" />
            <path d="M3 18h.01" />
          </svg>
        </button>
        <button class="text-zynk hover:text-white transition p-1.5 rounded-full hover:bg-zynk/10" title="Emoji">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10" />
            <path d="M8 14s1.5 2 4 2 4-2 4-2" />
            <line x1="9" x2="9.01" y1="9" y2="9" />
            <line x1="15" x2="15.01" y1="9" y2="9" />
          </svg>
        </button>
        <button class="text-zynk hover:text-white transition p-1.5 rounded-full hover:bg-zynk/10" title="Schedule">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
            <line x1="16" y1="2" x2="16" y2="6" />
            <line x1="8" y1="2" x2="8" y2="6" />
            <line x1="3" y1="10" x2="21" y2="10" />
            <path d="M12 14v4" />
            <path d="M12 14h4" />
          </svg>
        </button>
      </div>

      <div class="flex justify-between items-center mt-2">
        <div class="flex items-center gap-4">
          <span id="charCount" class="text-sm text-gray-500">0 / 280 chars</span>

          <div class="relative group flex items-center gap-2">
            <select id="expirySelect"
              class="bg-gray-100 dark:bg-[#1A1A1A] text-sm text-gray-700 dark:text-gray-300 rounded-lg px-2 py-1 outline-none border border-transparent focus:border-zynk appearance-none cursor-pointer">
              <option value="1">üî• 1 Hour</option>
              <option value="24" selected>‚è≥ 24 Hours</option>
              <option value="168">üìÖ 7 Days</option>
              <option value="custom">‚öôÔ∏è Custom...</option>
              <option value="never">‚ôæÔ∏è Never</option>
            </select>

            <!-- Custom Expiry Input (Hidden by default) -->
            <div id="customExpiryContainer"
              class="hidden flex items-center gap-1 bg-gray-100 dark:bg-[#1A1A1A] rounded-lg px-2 py-1">
              <input type="number" id="customTimeInput" value="2" min="1" max="365"
                class="w-12 bg-transparent text-sm text-center outline-none border-b border-gray-500 focus:border-zynk text-gray-800 dark:text-white">
              <select id="customUnitSelect"
                class="bg-transparent text-sm outline-none text-gray-600 dark:text-gray-400 cursor-pointer">
                <option value="hours">Hours</option>
                <option value="days">Days</option>
              </select>
            </div>
          </div>

          <div class="relative group">
            <select id="intentSelect"
              class="bg-gray-100 dark:bg-[#1A1A1A] text-sm text-gray-700 dark:text-gray-300 rounded-lg px-2 py-1 outline-none border border-transparent focus:border-zynk appearance-none cursor-pointer">
              <option value="vent" selected>üò§ Just Venting</option>
              <option value="thoughts">üí≠ Thoughts</option>
              <option value="question">‚ùì Ask Question</option>
              <option value="advice">üÜò Advice</option>
              <option value="debate">‚öîÔ∏è Debate</option>
              <option value="teach">üéì Teach</option>
              <option value="showcase">üåü Showcase</option>
            </select>
          </div>

          <div class="relative group">
            <select id="identitySelect"
              class="bg-gray-100 dark:bg-[#1A1A1A] text-sm text-gray-700 dark:text-gray-300 rounded-lg px-2 py-1 outline-none border border-transparent focus:border-zynk appearance-none cursor-pointer">
              <option value="public" selected>üë§ Public</option>
              <option value="semi">üé≠ Semi-anon</option>
              <option value="anon">üëª Fully anon</option>
            </select>
          </div>

          <label
            class="flex items-center gap-2 cursor-pointer text-sm text-gray-500 hover:text-zynk transition select-none">
            <input type="checkbox" id="allowReposts" class="accent-zynk" checked>
            <span>Allow Reposts</span>
          </label>
        </div>

        <button id="postBtn"
          class="bg-zynk text-black px-6 py-2 rounded-xl font-semibold hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed"
          disabled>
          Post
        </button>
      </div>
    </div>

    <div id="feedPosts">
      <!-- Posts will be injected here -->
    </div>

    <!-- REPLY MODAL -->
    <div id="replyModal"
      class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm opacity-0 transition-opacity duration-300">
      <div
        class="bg-white dark:bg-[#121212] w-full max-w-lg rounded-2xl p-6 shadow-2xl transform scale-95 transition-transform duration-300"
        id="replyModalContent">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">Reply to <span id="replyingTo" class="text-zynk">@user</span></h3>
          <button id="closeReplyBtn" class="text-gray-500 hover:text-white transition">‚úï</button>
        </div>

        <div
          class="mb-4 p-4 rounded-xl bg-gray-50 dark:bg-[#1A1A1A] text-sm text-gray-500 italic border-l-2 border-zynk">
          "<span id="replyContext">Post text...</span>"
        </div>

        <textarea id="replyInput" rows="4"
          class="w-full bg-gray-100 dark:bg-[#1A1A1A] rounded-xl p-4 outline-none resize-none text-gray-800 dark:text-gray-200 placeholder-gray-500 focus:ring-1 focus:ring-zynk transition"
          placeholder="Add your perspective (min 15 chars)..."></textarea>

        <div class="flex justify-between items-center mt-4">
          <div class="flex items-center gap-2 text-sm">
            <span id="qualityIndicator" class="w-2 h-2 rounded-full bg-red-500 transition-colors duration-300"></span>
            <span id="qualityText" class="text-gray-400 transition-colors duration-300">Too short</span>
          </div>
          <button id="sendReplyBtn" disabled
            class="bg-zynk text-black px-6 py-2 rounded-xl font-semibold hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed">
            Reply
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- RIGHT SIDEBAR -->
  <aside class="hidden lg:block w-64 p-6 border-l border-gray-200 dark:border-gray-800">
    <h2 class="font-semibold mb-4">Trending</h2>

    <ul class="space-y-3 text-gray-400">
      <li>#ZYNK</li>
      <li>#RawThoughts</li>
      <li>#NoNoise</li>
      <li>#MinimalSocial</li>
    </ul>
  </aside>
  <script>

    // State
    let selectedImages = [];

    function updatePostButtonState() {
      const text = input.value.trim();
      const length = input.value.length;
      const hasImages = selectedImages.length > 0;

      counter.textContent = `${length} / ${LIMIT}`;

      if (length > LIMIT) {
        counter.classList.add('text-red-500');
        postBtn.disabled = true;
      } else {
        counter.classList.remove('text-red-500');
        postBtn.disabled = length === 0 && !hasImages;
      }
    }

    // Global declarations for access in functions
    let input, counter, postBtn, identitySelect, intentSelect, allowRepostsCheckbox, feedPosts;
    const LIMIT = 280;

    document.addEventListener('DOMContentLoaded', () => {
      // Initialize DOM elements after load
      input = document.getElementById('postInput');
      counter = document.getElementById('charCount');
      postBtn = document.getElementById('postBtn');
      identitySelect = document.getElementById('identitySelect');
      intentSelect = document.getElementById('intentSelect');
      allowRepostsCheckbox = document.getElementById('allowReposts');
      feedPosts = document.getElementById('feedPosts');

      // Init listeners that depend on these elements
      if (input) {
        input.addEventListener('input', () => {
          updatePostButtonState();
          detectMood(input.value);
        });
      }

      if (postBtn) {
        postBtn.addEventListener('click', handlePostClick);
      }

      // Load posts on startup (Safe Load)
      try {
        if (typeof loadPosts === 'function') {
          loadPosts();
        } else {
          console.error("Zynk: loadPosts is not a function");
        }
      } catch (err) {
        console.error("Zynk: Error loading posts", err);
      }
    });

    // Separated handler for cleanliness and hoisting
    async function handlePostClick() {
      try {
        const text = input.value.trim();

        // Allow post if there are images, even if no text
        if (!text && selectedImages.length === 0) {
          alert("Post empty hai bhai");
          return;
        }

        postBtn.disabled = true; // Disable immediately to prevent double clicks

        const expiryVal = expirySelect.value;
        const identity = identitySelect.value;
        const intent = intentSelect.value;
        const allowReposts = allowRepostsCheckbox.checked;
        const now = Date.now();

        let expiryTime = null; // Default to never/null

        if (expiryVal !== 'never') {
          let hours = 0;
          if (expiryVal === 'custom') {
            const val = parseFloat(document.getElementById('customTimeInput').value) || 0;
            const unit = document.getElementById('customUnitSelect').value;
            hours = unit === 'days' ? val * 24 : val;
          } else {
            hours = parseFloat(expiryVal);
          }

          if (hours > 0) {
            expiryTime = now + (hours * 60 * 60 * 1000);
          } else {
            if (expiryVal === 'custom' && hours <= 0) {
              alert("Please enter a valid time");
              postBtn.disabled = false; // Re-enable
              return;
            }
          }
        }

        let author = 'You';
        let handle = '@you';
        let avatar = localStorage.getItem("zynkAvatar") || "";

        const savedProfile = JSON.parse(localStorage.getItem("zynkProfile"));
        if (savedProfile) {
          author = savedProfile.name || 'You';
          handle = savedProfile.username || '@you';
        }

        if (identity === 'semi') {
          author = 'Zynk Member';
          handle = '@hidden';
          avatar = "";
        } else if (identity === 'anon') {
          author = 'Anonymous';
          handle = `@${Math.random().toString(36).substring(2, 7)}`;
          avatar = "";
        }

        // Convert images to Base64 with Compression
        const imageAttachments = await Promise.all(selectedImages.map(file => compressImage(file)));

        const post = {
          id: crypto.randomUUID(),
          text: text,
          images: imageAttachments, // Add images
          timestamp: now,
          expiry: expiryTime,
          author: author,
          handle: handle,
          avatar: avatar,
          identity: identity,
          intent: intent,
          allowReposts: allowReposts,
          frozen: false
        };

        savePost(post);
        renderPost(post, true);

        // Reset
        input.value = '';
        selectedImages = [];
        renderImagePreview();
        updatePostButtonState();
      } catch (err) {
        console.error("Post failed:", err);
        // Alert handled in savePost for storage, but handle others
        if (err.name !== 'QuotaExceededError') {
          alert("Failed to post: " + err.message);
        }
        postBtn.disabled = false; // Re-enable on error
      }
    }

    // Global User Profile (Safe Parse)
    let savedProfile = null;
    try {
      savedProfile = JSON.parse(localStorage.getItem("zynkProfile"));
    } catch (e) {
      console.error("Zynk: Error parsing profile", e);
    }


    function openImagePicker() {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.multiple = true;
      input.click();

      input.onchange = () => {
        const files = Array.from(input.files);

        files.forEach(file => {
          if (selectedImages.length >= 4) {
            alert("Max 4 images allowed");
            return;
          }
          selectedImages.push(file);
        });

        renderImagePreview();
        updatePostButtonState();
      };
    }

    function renderImagePreview() {
      const preview = document.getElementById("imagePreview");
      preview.innerHTML = "";

      if (selectedImages.length === 0) {
        preview.classList.add("hidden");
        return;
      }

      preview.classList.remove("hidden");

      selectedImages.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = () => {
          preview.innerHTML += `
            <div class="image-box">
              <img src="${reader.result}">
              <div class="remove-img" onclick="removeImage(${index})">‚úï</div>
            </div>
          `;
        };
        reader.readAsDataURL(file);
      });
    }

    function removeImage(index) {
      selectedImages.splice(index, 1);
      renderImagePreview();
      updatePostButtonState();
    }

    // COMPRESSION UTILITY
    function compressImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
          const img = new Image();
          img.src = event.target.result;
          img.onload = () => {
            // Dimensions
            const maxWidth = 800; // Good balance for mobile/feed
            const maxHeight = 800;
            let width = img.width;
            let height = img.height;

            // Resize logic
            if (width > height) {
              if (width > maxWidth) {
                height *= maxWidth / width;
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width *= maxHeight / height;
                height = maxHeight;
              }
            }

            // Canvas
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // Export compressed (JPEG 0.6 is good for social feeds)
            const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
            resolve(dataUrl);
          };
          img.onerror = (err) => reject(err);
        };
        reader.onerror = (err) => reject(err);
      });
    }

    function savePost(post) {
      try {
        const posts = JSON.parse(localStorage.getItem('zynk_posts') || '[]');
        posts.unshift(post);
        localStorage.setItem('zynk_posts', JSON.stringify(posts));
      } catch (e) {
        console.error("Storage error:", e);
        if (e.name === 'QuotaExceededError') {
          alert("Storage full! Images are too large for this demo. Try smaller images or clear space.");
          throw e; // Re-throw to stop processing
        }
      }
    }

    function loadPosts() {
      const posts = JSON.parse(localStorage.getItem('zynk_posts') || '[]');
      const now = Date.now();

      // Clear current feed
      const feedContainer = document.getElementById('feedPosts'); // Need to target this? NO, renderPost appends...
      // Previous loadPosts logic didn't clear! It just appended? 
      // Actually there's a bug in previous logic: "Add static dummy posts... validPosts.forEach(renderPost)".
      // If I call loadPosts again, it will duplicate. 
      // I need to clear the container first.

      // Let's find the container. It's likely <div id="feedPosts">...</div> but wait, 
      // in HTML structure (line 447 in viewing code) it variables `feedPosts`.
      // I need to clear it.

      const container = document.getElementById('feedPosts');
      if (container) container.innerHTML = '';

      // Keep if expiry is null (Never) OR expiry is in future
      const validPosts = posts.filter(p => !p.expiry || p.expiry > now);

      // Update storage if we filtered out expired posts
      if (posts.length !== validPosts.length) {
        localStorage.setItem('zynk_posts', JSON.stringify(validPosts));
      }

      // Filter by Tab
      let postsToRender = validPosts;
      if (currentFeedTab === 'inOrbit') {
        const inOrbitList = getInOrbit();
        // Filter: Author handle is in Orbit list OR it's my own post
        postsToRender = validPosts.filter(p => inOrbitList.includes(p.handle) || p.handle === '@you' || p.handle === savedProfile?.username);

        if (postsToRender.length === 0) {
          if (container) container.innerHTML = `<div class="p-8 text-center text-gray-500">Your Orbit is empty. Start orbiting others to see their thoughts here.</div>`;
          return;
        }
      }

      postsToRender.forEach(post => {
        // Quick fix: if it's "You" and has no avatar, try to use current one
        if ((post.author === 'You' || post.handle === '@you') && !post.avatar) {
          const currentAvatar = localStorage.getItem("zynkAvatar");
          if (currentAvatar) post.avatar = currentAvatar;
        }
        renderPost(post, false)
      });
    }

    function getIntentBadge(intent) {
      const intents = {
        'vent': { label: 'üò§ Just Venting', class: 'bg-red-500/10 text-red-500' },
        'thoughts': { label: 'üí≠ Thoughts', class: 'bg-blue-500/10 text-blue-500' },
        'question': { label: '‚ùì Question', class: 'bg-yellow-500/10 text-yellow-500' },
        'advice': { label: 'üÜò Advice', class: 'bg-orange-500/10 text-orange-500' },
        'debate': { label: '‚öîÔ∏è Debate', class: 'bg-purple-500/10 text-purple-500' },
        'teach': { label: 'üéì Teach', class: 'bg-green-500/10 text-green-500' },
        'showcase': { label: 'üåü Showcase', class: 'bg-pink-500/10 text-pink-500' }
      };
      return intents[intent] || intents['vent'];
    }

    function renderPost(post, animate) {
      const timeLeft = getTimeLeft(post.expiry);
      const intentStyle = getIntentBadge(post.intent || 'vent');

      const replyAction = post.frozen
        ? `<span class="opacity-50 cursor-not-allowed text-gray-400" title="Replies disabled">Locked üîí</span>`
        : `<span class="hover:text-zynk transition transform hover:scale-105 cursor-pointer" onclick="openReply('${post.handle}', '${post.text.replace(/'/g, "\\'")}')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
           </span>`;

      const freezeAction = `<span onclick="toggleFreeze('${post.id}')" class="cursor-pointer hover:text-blue-500 transition select-none">${post.frozen ? 'Unfreeze ‚ùÑÔ∏è' : 'Freeze üßä'}</span>`;
      const expiryTitle = post.expiry ? `Exports at ${new Date(post.expiry).toLocaleString()}` : 'Never expires';

      const postHTML = `
        <div id="post-${post.id}" class="post-card p-6 border-b border-gray-200 dark:border-gray-800 transition-all duration-300 ease-out hover:bg-gray-100 dark:hover:bg-[#141414] hover:-translate-y-0.5 ${animate ? 'animate-post' : ''} ${post.frozen ? 'bg-blue-50/30 dark:bg-blue-900/10' : ''}">
          <div class="flex gap-4">
             <!-- Avatar (Dynamic) -->
             <img src="${post.avatar || 'https://via.placeholder.com/40'}" 
                  class="${(post.author === 'You' || post.handle === '@you' || post.identity === 'public') ? 'post-avatar' : ''} w-10 h-10 rounded-full object-cover bg-gray-700 flex-shrink-0" 
                  alt="${post.author}">
            <div class="flex-1">
              <div class="flex justify-between items-start">
                <div class="flex items-center gap-2">
                  <span class="${(post.author === 'You' || post.handle === '@you' || post.identity === 'public') ? 'post-name' : ''} font-semibold">${post.author}</span>
                  <span class="${(post.author === 'You' || post.handle === '@you' || post.identity === 'public') ? 'post-handle' : ''} text-sm text-gray-500">${post.handle}</span>
                  <span class="text-xs ${intentStyle.class} px-2 py-0.5 rounded-full">${intentStyle.label}</span>
                  ${post.frozen ? '<span class="text-xs bg-gray-200 dark:bg-gray-800 text-gray-500 px-2 py-0.5 rounded-full border border-gray-300 dark:border-gray-700">Frozen ‚ùÑÔ∏è</span>' : ''}
                  
                  <!-- ORBIT BUTTON -->
                  ${(post.handle !== '@you' && post.handle !== savedProfile?.username) ?
          `<button onclick="toggleOrbitBtn('${post.handle}', this)" class="text-xs border border-zynk text-zynk px-2 py-0.5 rounded-full hover:bg-zynk hover:text-black transition">
                        ${isInOrbit(post.handle) ? 'In Orbit' : 'Orbit'}
                     </button>`
          : ''}

                </div>
                <span class="expiry-countdown text-xs font-mono text-orange-500 bg-orange-500/10 px-2 py-0.5 rounded-full transition-colors duration-500" 
                      title="${expiryTitle}"
                      data-expiry="${post.expiry || ''}">
                  üî• ${timeLeft}
                </span>
              </div>
              
              <div class="mt-2 text-gray-800 dark:text-gray-200">
                <p id="text-${post.id}" class="${post.text.length > 150 ? 'line-clamp-3' : ''} whitespace-pre-wrap transition-all">${post.text}</p>
                ${post.text.length > 150 ? `<button onclick="toggleExpand('${post.id}')" class="text-xs text-zynk hover:underline mt-1">Show more</button>` : ''}
              </div>

              <!-- Render Attached Images -->
              ${post.images && post.images.length > 0 ? `
                  <div class="mt-3 flex gap-2 overflow-x-auto pb-2">
                      ${post.images.map(img => `<img src="${img}" class="h-32 w-auto rounded-lg border border-gray-200 dark:border-gray-800 object-cover">`).join('')}
                  </div>
              ` : ''}
              
                <div class="flex gap-6 mt-4 text-gray-500">
                ${replyAction}
                
                <span class="${post.allowReposts !== false ? 'hover:text-zynk transition transform hover:scale-105 cursor-pointer' : 'opacity-50 cursor-not-allowed'}" title="${post.allowReposts !== false ? 'Repost' : 'Reposts disabled'}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 1l4 4-4 4"></path><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><path d="M7 23l-4-4 4-4"></path><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
                </span>
                
                <div class="like-container relative">
                   <button class="like-btn flex items-center gap-1 hover:text-zynk transition cursor-pointer select-none" onmousedown="startLike(this)" onmouseup="cancelLike(this)" onmouseleave="cancelLike(this)" ontouchstart="startLike(this)" ontouchend="cancelLike(this)">
                     <span class="like-fill"></span>
                     <span class="like-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                     </span>
                   </button>
                </div>
                ${freezeAction}
              </div>
            </div>
          </div>
        </div>
      `;

      const list = animate ? feedPosts : feedPosts;
      if (animate) {
        list.insertAdjacentHTML('afterbegin', postHTML);
      } else {
        list.insertAdjacentHTML('beforeend', postHTML); // Updated to append correctly on load
      }
    }

    // SLOW LIKE LOGIC
    let likeTimer;

    function startLike(btn) {
      if (btn.classList.contains('liked')) {
        // Toggle off instantly if already liked (or maybe slow unlike? sticking to instant toggle for now or blocked?)
        // Let's make toggle off instant for better UX, or just keep it simple.
        // Request was "Like button 2 sec hold karna pade". 
        // Let's assume enabling like takes 2s. Disabling can be instant or same. 
        // For "Mindful engagement", unliking should probably also be mindful, but let's stick to Like first.
        btn.classList.remove('liked');
        btn.querySelector('.like-icon').textContent = 'Like';
        return;
      }

      btn.classList.add('holding');

      likeTimer = setTimeout(() => {
        completeLike(btn);
      }, 1000);
    }

    function cancelLike(btn) {
      if (likeTimer) clearTimeout(likeTimer);
      btn.classList.remove('holding');
    }

    function completeLike(btn) {
      btn.classList.remove('holding');
      btn.classList.add('liked');
      btn.classList.add('like-pop');
      btn.querySelector('.like-icon').textContent = 'Liked ‚ù§Ô∏è';

      setTimeout(() => btn.classList.remove('like-pop'), 300);

      // Haptic feedback if available
      if (navigator.vibrate) navigator.vibrate(50);
    }

    function getTimeLeft(expiry) {
      if (!expiry) return 'Forever ‚ôæÔ∏è';
      const now = Date.now();
      const diff = expiry - now;

      if (diff <= 0) return 'Expired';

      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

      if (days > 0) return `${days}d left`;
      if (hours > 0) return `${hours}h left`;
      return `${minutes}m left`;
    }

    function toggleExpand(id) {
      const p = document.getElementById(`text-${id}`);
      const btn = p.nextElementSibling;
      p.classList.remove('line-clamp-3');
      if (btn) btn.remove();
    }

    function toggleFreeze(postId) {
      const posts = JSON.parse(localStorage.getItem('zynk_posts') || '[]');
      const postIndex = posts.findIndex(p => p.id === postId);

      if (postIndex !== -1) {
        posts[postIndex].frozen = !posts[postIndex].frozen;
        localStorage.setItem('zynk_posts', JSON.stringify(posts));

        // Re-render specifically or reload? 
        // Simple reload for now to reflect UI changes across components if needed, 
        // OR find the element and replace it. Replacing is smoother.
        const oldElement = document.getElementById(`post-${postId}`);
        if (oldElement) {
          oldElement.remove(); // Remove old

          // We need to re-render in place? 
          // renderPost appends to list. 
          // Let's reload page for simplicity to ensure lists are correct? 
          // No, user experience.
          // Let's just reload logic.
          location.reload();
        }
      }
    }

    // MOOD DETECTION (Local AI)
    function detectMood(text) {
      const lowerText = text.toLowerCase();

      // Keywords
      const angryWords = ['hate', 'stupid', 'garbage', 'furious', 'annoy', 'worst', 'bad', 'angry', 'hell', 'damn'];
      const sadWords = ['lonely', 'depressed', 'sad', 'cry', 'miss', 'hurt', 'pain', 'sorry', 'alone', 'blue'];
      const happyWords = ['love', 'happy', 'great', 'peace', 'chill', 'amazing', 'good', 'best', 'bless', 'joy'];

      let mood = 'neutral';

      if (angryWords.some(w => lowerText.includes(w))) mood = 'angry';
      else if (sadWords.some(w => lowerText.includes(w))) mood = 'sad';
      else if (happyWords.some(w => lowerText.includes(w))) mood = 'happy';

      const root = document.documentElement;
      const postArea = document.querySelector('.post-card-container') || input.parentElement.parentElement; // Target wrapper

      if (mood === 'angry') {
        root.style.setProperty('--mood-color', '#ff4d4d'); // Red
        root.style.setProperty('--mood-speed', '0.1s');
        postBtn.classList.add('mood-btn');
        input.parentElement.classList.add('mood-glow'); // Suggest adding glow to container
      } else if (mood === 'sad') {
        root.style.setProperty('--mood-color', '#4da6ff'); // Blue
        root.style.setProperty('--mood-speed', '1.5s');
        postBtn.classList.add('mood-btn');
        input.parentElement.classList.add('mood-glow');
      } else if (mood === 'happy') {
        root.style.setProperty('--mood-color', '#00ffaa'); // Greenish Teal
        root.style.setProperty('--mood-speed', '0.4s');
        postBtn.classList.add('mood-btn');
        input.parentElement.classList.add('mood-glow');
      } else {
        // Reset
        root.style.setProperty('--mood-color', '#12E6E6');
        root.style.setProperty('--mood-speed', '0.3s');
        postBtn.classList.remove('mood-btn');
        input.parentElement.classList.remove('mood-glow');
      }
    }

    // LIVE COUNTDOWN LOGIC
    // Update every second
    setInterval(updateCountdowns, 1000);

    function updateCountdowns() {
      const badges = document.querySelectorAll('.expiry-countdown');
      const now = Date.now();
      const postsToRemove = [];

      badges.forEach(badge => {
        const expiryStr = badge.getAttribute('data-expiry');

        // Handle Never/Null
        if (!expiryStr || expiryStr === 'null' || expiryStr === 'undefined') {
          badge.innerText = 'Forever ‚ôæÔ∏è';
          badge.classList.remove('animate-pulse', 'text-red-500', 'bg-red-500/10');
          badge.classList.add('text-orange-500', 'bg-orange-500/10');
          return;
        }

        const expiry = parseInt(expiryStr);
        if (isNaN(expiry)) { // Handle invalid parse
          badge.innerText = 'Forever ‚ôæÔ∏è';
          return;
        }

        const diff = expiry - now;

        if (diff <= 0) {
          badge.innerText = 'Expired';
          badge.classList.remove('animate-pulse', 'text-red-500', 'bg-red-500/10', 'text-orange-500', 'bg-orange-500/10');
          badge.classList.add('text-gray-500', 'bg-gray-500/10');

          // Mark for removal
          const postCard = badge.closest('.post-card');
          if (postCard && !postCard.classList.contains('fading-out')) {
            postCard.classList.add('fading-out');
            postCard.style.transition = 'opacity 1s';
            postCard.style.opacity = '0';
            setTimeout(() => postCard.remove(), 1000);
            // Also removal from storage should happen via loadPosts or check logic
          }
          return;
        }

        // URGENCY EFFECT (< 5 mins)
        if (diff < 5 * 60 * 1000) {
          badge.classList.add('animate-pulse', 'text-red-500', 'bg-red-500/10');
          badge.classList.remove('text-orange-500', 'bg-orange-500/10');
        } else {
          badge.classList.remove('animate-pulse', 'text-red-500', 'bg-red-500/10');
          badge.classList.add('text-orange-500', 'bg-orange-500/10');
        }

        badge.innerText = 'üî• ' + formatTimeLeft(diff);
      });
    }

    function formatTimeLeft(diff) {
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);

      if (days > 0) return `${days}d ${hours}h left`;
      if (hours > 0) return `${hours}h ${minutes}m left`;
      // Show seconds if under an hour
      return `${minutes}m ${seconds}s left`;
    }

    // Helper to format time left (initial)
    function getTimeLeft(expiry) {
      if (!expiry) return 'Forever ‚ôæÔ∏è';
      const now = Date.now();
      const diff = expiry - now;
      if (diff <= 0) return 'Expired';
      return formatTimeLeft(diff);
    }

    // Theme Toggle Logic
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');

    function updateIcon(isDark) {
      themeIcon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
    }

    // Set initial icon
    updateIcon(document.documentElement.classList.contains('dark'));

    themeToggle.addEventListener('click', () => {
      const isDark = theme.toggle();
      updateIcon(isDark);
    });

    // ORBIT LOGIC (Feed)
    function toggleOrbitBtn(handle, btn) {
      event.stopPropagation(); // Prevent post click
      const nowInOrbit = toggleOrbit(handle);

      if (nowInOrbit) {
        btn.textContent = 'In Orbit';
        btn.classList.add('bg-zynk', 'text-black');
        btn.classList.remove('text-zynk');
      } else {
        btn.textContent = 'Orbit';
        btn.classList.remove('bg-zynk', 'text-black');
        btn.classList.add('text-zynk');
      }
    }

    // REPLY LOGIC

    let currentFeedTab = 'foryou';

    function switchFeed(type) {
      currentFeedTab = type;
      const forYouTab = document.getElementById('tab-foryou');
      const inOrbitTab = document.getElementById('tab-inOrbit');

      const forYouSpan = forYouTab.querySelector('span');
      const inOrbitSpan = inOrbitTab.querySelector('span');

      const forYouLine = forYouTab.querySelector('div');
      const inOrbitLine = inOrbitTab.querySelector('div');

      if (type === 'foryou') {
        // Active: For You
        forYouSpan.className = 'font-bold text-gray-900 dark:text-white';
        forYouLine.className = 'absolute bottom-0 left-0 w-full h-1 bg-zynk rounded-full';

        // Inactive: In Orbit
        inOrbitSpan.className = 'font-medium text-gray-500 group-hover:text-gray-900 dark:text-gray-500 dark:group-hover:text-gray-300';
        inOrbitLine.className = 'absolute bottom-0 left-0 w-full h-1 bg-transparent rounded-full';
      } else {
        // Active: In Orbit
        inOrbitSpan.className = 'font-bold text-gray-900 dark:text-white';
        inOrbitLine.className = 'absolute bottom-0 left-0 w-full h-1 bg-zynk rounded-full';

        // Inactive: For You
        forYouSpan.className = 'font-medium text-gray-500 group-hover:text-gray-900 dark:text-gray-500 dark:group-hover:text-gray-300';
        forYouLine.className = 'absolute bottom-0 left-0 w-full h-1 bg-transparent rounded-full';
      }

      // Reload posts with filter
      loadPosts();
    }

    const replyModal = document.getElementById('replyModal');
    const replyModalContent = document.getElementById('replyModalContent');
    const closeReplyBtn = document.getElementById('closeReplyBtn');
    const replyInput = document.getElementById('replyInput');
    const sendReplyBtn = document.getElementById('sendReplyBtn');
    const qualityIndicator = document.getElementById('qualityIndicator');
    const qualityText = document.getElementById('qualityText');
    const replyingTo = document.getElementById('replyingTo');
    const replyContext = document.getElementById('replyContext');

    function openReply(handle, text) {
      replyingTo.textContent = handle;
      replyContext.textContent = text.length > 50 ? text.substring(0, 50) + '...' : text;

      replyModal.classList.remove('hidden');
      requestAnimationFrame(() => {
        replyModal.classList.remove('opacity-0');
        replyModalContent.classList.remove('scale-95');
        replyModalContent.classList.add('scale-100');
      });
      replyInput.focus();
    }

    function closeReply() {
      replyModal.classList.add('opacity-0');
      replyModalContent.classList.remove('scale-100');
      replyModalContent.classList.add('scale-95');

      setTimeout(() => {
        replyModal.classList.add('hidden');
        replyInput.value = '';
        updateQuality(); // Reset
      }, 300);
    }

    closeReplyBtn.addEventListener('click', closeReply);
    replyModal.addEventListener('click', (e) => {
      if (e.target === replyModal) closeReply();
    });

    // Quality Filter Logic
    replyInput.addEventListener('input', updateQuality);

    function updateQuality() {
      const text = replyInput.value.trim();
      const length = text.length;

      // Simple Heuristics
      const isShort = length < 15;
      const isMedium = length >= 15 && length < 40;
      const isLong = length >= 40;

      // Anti-spam (basic)
      const spamWords = ['lol', 'nice', 'cool', 'k', 'ok', 'good'];
      const isSpam = spamWords.includes(text.toLowerCase());

      if (isSpam || isShort) {
        setQuality('bad', 'Too short / Low effort');
        sendReplyBtn.disabled = true;
      } else if (isMedium) {
        setQuality('medium', 'Getting there...');
        sendReplyBtn.disabled = false;
      } else {
        setQuality('good', 'Great depth! üåü');
        sendReplyBtn.disabled = false;
      }
    }

    function setQuality(level, msg) {
      qualityText.textContent = msg;
      if (level === 'bad') {
        qualityIndicator.className = 'w-2 h-2 rounded-full bg-red-500 transition-colors duration-300';
        qualityText.className = 'text-red-400 text-sm transition-colors duration-300';
      } else if (level === 'medium') {
        qualityIndicator.className = 'w-2 h-2 rounded-full bg-yellow-500 transition-colors duration-300';
        qualityText.className = 'text-yellow-400 text-sm transition-colors duration-300';
      } else {
        qualityIndicator.className = 'w-2 h-2 rounded-full bg-green-500 transition-colors duration-300';
        qualityText.className = 'text-green-400 text-sm transition-colors duration-300';
      }
    }

    sendReplyBtn.addEventListener('click', () => {
      // Here you would normally save the reply
      // For visual feedback:
      sendReplyBtn.textContent = 'Sent!';
      setTimeout(() => {
        closeReply();
        sendReplyBtn.textContent = 'Reply';
      }, 500);
    });
  </script>

  <style>
    @keyframes postEnter {
      from {
        opacity: 0;
        transform: translateY(12px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Mood Variables */
    :root {
      --mood-color: #12E6E6;
      /* Default Zynk */
      --mood-speed: 0.3s;
    }

    /* Mood Styles applied to Post Area */
    #postInput {
      caret-color: var(--mood-color);
      transition: color 1s ease;
    }

    .mood-glow {
      box-shadow: 0 0 20px -5px var(--mood-color);
      transition: box-shadow 1s ease, border-color 1s ease;
      border-color: var(--mood-color) !important;
    }

    .mood-btn {
      background-color: var(--mood-color) !important;
      transition: background-color 1s ease, transform var(--mood-speed);
    }

    .animate-post {
      animation: postEnter 0.4s ease-out forwards;
    }

    /* Slow Like Animation */
    @keyframes likePop {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.2);
      }

      100% {
        transform: scale(1);
      }
    }

    .like-pop {
      animation: likePop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .like-btn {
      position: relative;
      overflow: hidden;
      transition: color 0.3s;
    }

    .like-fill {
      position: absolute;
      top: 0;
      left: 0;
      width: 0%;
      height: 100%;
      background-color: rgba(18, 230, 230, 0.2);
      /* Zynk color with opacity */
      transition: width 0s linear;
      /* Default no transition for instant reset */
      z-index: -1;
      border-radius: 4px;
    }

    .like-btn.holding .like-fill {
      width: 100%;
      transition: width 1s linear;
      /* 1s fill */
    }

    .like-btn.liked {
      color: #12E6E6;
      /* Zynk color */
    }

    .like-btn.liked .like-fill {
      width: 0%;
      /* Reset fill */
    }
  </style>
  <script>
    // Load user avatar for posts
    const avatar = localStorage.getItem("zynkAvatar");
    const postAvatar = document.getElementById("postAvatar");

    if (avatar && postAvatar) {
      postAvatar.src = avatar;
    } else if (postAvatar) {
      postAvatar.src = "https://via.placeholder.com/40";
    }

    function updatePostAvatars() {
      const avatar = localStorage.getItem("zynkAvatar");
      if (!avatar) return;

      document.querySelectorAll(".post-avatar").forEach(img => {
        // Only update if it's currently a 'You' avatar or we want to force update all 'You' posts?
        // The request says "Feed page me LIVE update logic".
        // It blindly updates ALL .post-avatar. 
        // CAUTION: This might overwrite other users' avatars if they also use .post-avatar class.
        // But currently strict class usage in renderPost applies it to ALL posts.
        // Wait, renderPost is used for EVERY post, including "Anonymous" or "Zynk Member".
        // If we update ALL .post-avatar, we will overwrite Anon avatars too!
        // The user's request: "Feed page ‚Äì avatar ko dynamic rakho... Ensure har post avatar class-based ho... document.querySelectorAll('.post-avatar').forEach(img => { img.src = avatar; });"
        // This logic IS flawed if it updates everyone. But adhering to user instruction strictly?
        // "Feed page me LIVE update logic (üî• CORE) ... document.querySelectorAll('.post-avatar').forEach..."
        // I should probably add a check or only add the class to "You" posts.
        // But for now, I will implement as requested but maybe refine the selector or the class application in renderPost.
        // Better: In renderPost, ONLY add `post-avatar` class if `post.author === 'You'`.
        // Let's modify the previous step or just do it here.
        // Actually, the previous step added `post-avatar` to ALL posts in `renderPost`.
        // I should update `renderPost` to conditionally add the class.
        // BUT, the static "You" post (if any) and the new dynamic "You" posts need it.
        // Let's refine `renderPost` first or right now.
        // Wait, I can't refine renderPost in this block.
        // I will use a smarter selector in the JS:
        // Or just let it update all for now and see? No, that breaks the app logic (Anon becomes You).
        // I will trust the user wants "You" posts updated.
        // Let's Assume the user implicitly meant "My posts".
        // I'll update renderPost to only add `post-avatar` class to "You" posts.
        // Re-reading step 2: "Ensure har post avatar class-based ho, id-based nahi (kyunki multiple posts honge)".
        // It doesn't explicitly say "only for my posts".
        // But functionally, overwriting Anon is bad.
        // I will modify `renderPost` to output `<img class="${post.author === 'You' ? 'post-avatar' : ''} ...">`
        // I need to redo the renderPost replacement to be conditional.

        img.src = avatar;
      });
    }

    // Initial load
    updatePostAvatars();

    // üî• Listen for profile image updates
    window.addEventListener("storage", (event) => {
      if (event.key === "zynkAvatarUpdated") {
        updatePostAvatars();
      }
    });

    // Also listen for local custom event if on same page (unlikely for profile->feed but good practice)
    window.addEventListener("zynkAvatarUpdated", () => {
      updatePostAvatars();
    });

    // Live Profile Text Updates (Name/Username)
    function updatePostIdentity() {
      const savedProfile = JSON.parse(localStorage.getItem("zynkProfile"));
      if (!savedProfile) return;

      const newName = savedProfile.name || "You";
      const newHandle = savedProfile.username || "@you";

      document.querySelectorAll(".post-name").forEach(el => el.textContent = newName);
      document.querySelectorAll(".post-handle").forEach(el => el.textContent = newHandle);
    }

    // Initial check (optional, renderPost handles it, but ensures sync if page was cached)
    updatePostIdentity();

    window.addEventListener("storage", (event) => {
      if (event.key === "zynkAvatarUpdated") {
        updatePostAvatars();
      }
      if (event.key === "zynkProfileUpdated") {
        updatePostIdentity();
      }
    });

    window.addEventListener("zynkProfileUpdated", () => {
      updatePostIdentity();
    });
  </script>
</body>

</html>